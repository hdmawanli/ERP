{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2>编辑质量检测</h2>
    <form method="POST" action="">
        <div class="form-group">
            <label for="batch_id">批次号</label>
            <select class="form-control" id="batch_id" name="batch_id" required>
                {% for batch in batches %}
                <option value="{{ batch.batch_id }}" {% if batch.batch_id == test.batch_id %}selected{% endif %}>
                    {{ batch.batch_number }} ({{ batch.product.product_name }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="test_type">检测类型</label>
            <input type="text" class="form-control" id="test_type" name="test_type" value="{{ test.test_type }}" required>
        </div>
        <div class="form-group">
            <label for="operator">操作员</label>
            <input type="text" class="form-control" id="operator" name="operator" value="{{ test.operator }}" required>
        </div>

        <h4 class="mt-4">检测项目</h4>
        <div id="test_items_container">
            {% for item in test.test_items %}
            <div class="test_item_row mb-3">
                <div class="row">
                    <div class="col">
                        <input type="text" class="form-control" name="test_item_name[]" value="{{ item.test_item_name }}" placeholder="项目名称">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="test_value[]" value="{{ item.test_value }}" placeholder="检测值">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="unit[]" value="{{ item.unit }}" placeholder="单位">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" name="standard_value[]" value="{{ item.standard_value }}" placeholder="标准值">
                    </div>
                    <div class="col-auto">
                        <input type="checkbox" name="is_qualified[]" {% if item.is_qualified %}checked{% endif %}>
                        合格
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-danger remove_item">删除</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <button type="button" id="add_item" class="btn btn-secondary mb-3">添加检测项目</button>
        <button type="submit" class="btn btn-primary">保存</button>
        <a href="{{ url_for('quality_control.index') }}" class="btn btn-secondary">取消</a>
    </form>
</div>

<script>
// 动态添加检测项目
$('#add_item').click(function() {
    var newRow = `
        <div class="test_item_row mb-3">
            <div class="row">
                <div class="col">
                    <input type="text" class="form-control" name="test_item_name[]" placeholder="项目名称">
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="test_value[]" placeholder="检测值">
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="unit[]" placeholder="单位">
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="standard_value[]" placeholder="标准值">
                </div>
                <div class="col-auto">
                    <input type="checkbox" name="is_qualified[]" checked> 合格
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-danger remove_item">删除</button>
                </div>
            </div>
        </div>
    `;
    $('#test_items_container').append(newRow);
});

// 动态删除检测项目
$(document).on('click', '.remove_item', function() {
    $(this).closest('.test_item_row').remove();
});
</script>
{% endblock %}